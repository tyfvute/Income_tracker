{% extends 'base.html' %}{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<div class="mx-auto" style="max-width: 1200px;"><div class="row g-4 justify-content-center">
    <div class="col-md-5">
        <div class="card p-3 mb-4 shadow-sm border-danger"><div class="text-center mb-3"><small class="text-muted fw-bold text-uppercase">Всего расходов</small><h3 class="text-danger fw-bold">{{ "{:,}".format(total_exp|int).replace(',', ' ') }} ₽</h3></div>
            <div class="row align-items-center"><div class="col-5"><canvas id="expChart"></canvas></div><div class="col-7">{% if total_exp > 0 %}<div class="bg-transparent"><div class="pb-0 small fw-bold text-muted mb-1">Детализация</div><div style="max-height: 150px; overflow-y: auto;"><table class="table table-sm small mb-0 table-borderless" style="table-layout: fixed; width: 100%;"><tbody>
                {% for cat, sum in exp_stats.items() %}<tr onmouseover="toggleChart('expChart', {{ loop.index0 }}, true)" onmouseout="toggleChart('expChart', {{ loop.index0 }}, false)" style="cursor: pointer;"><td class="text-muted small" style="width: 20px;">{{ loop.index }}.</td><td class="fw-bold text-danger" style="width: 65px; white-space: nowrap;">{% set p = (sum / total_exp) * 100 %}{% if p > 99 and p < 100 %}>99%{% elif p > 0 and p < 1 %}<1%{% else %}{{ p|round|int }}%{% endif %}</td><td class="fw-bold text-truncate" title="{{ "{:,}".format(sum|int).replace(',', ' ') }} ₽">{{ "{:,}".format(sum|int).replace(',', ' ') }} ₽</td><td class="text-muted text-truncate" title="{{ cat }}">{{ cat }}</td></tr>{% endfor %}
            </tbody></table></div></div>{% endif %}</div></div>
        </div>
        <div class="card p-3 shadow-sm border-success"><div class="text-center mb-3"><small class="text-muted fw-bold text-uppercase">Всего доходов</small><h3 class="text-success fw-bold">{{ "{:,}".format(total_inc|int).replace(',', ' ') }} ₽</h3></div>
            <div class="row align-items-center"><div class="col-5"><canvas id="incChart"></canvas></div><div class="col-7">{% if total_inc > 0 %}<div class="bg-transparent"><div class="pb-0 small fw-bold text-muted mb-1">Детализация</div><div style="max-height: 150px; overflow-y: auto;"><table class="table table-sm small mb-0 table-borderless" style="table-layout: fixed; width: 100%;"><tbody>
                {% for cat, sum in inc_stats.items() %}<tr onmouseover="toggleChart('incChart', {{ loop.index0 }}, true)" onmouseout="toggleChart('incChart', {{ loop.index0 }}, false)" style="cursor: pointer;"><td class="text-muted small" style="width: 20px;">{{ loop.index }}.</td><td class="fw-bold text-success" style="width: 65px; white-space: nowrap;">{% set p = (sum / total_inc) * 100 %}{% if p > 99 and p < 100 %}>99%{% elif p > 0 and p < 1 %}<1%{% else %}{{ p|round|int }}%{% endif %}</td><td class="fw-bold text-truncate" title="{{ "{:,}".format(sum|int).replace(',', ' ') }} ₽">{{ "{:,}".format(sum|int).replace(',', ' ') }} ₽</td><td class="text-muted text-truncate" title="{{ cat }}">{{ cat }}</td></tr>{% endfor %}
            </tbody></table></div></div>{% endif %}</div></div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card p-4 text-center bg-purple text-white border-0 shadow mb-4" style="border-radius: 25px;"><p class="mb-1 opacity-75 small">Ваш кошелек</p><h5 class="mb-2">Текущий баланс</h5><div class="display-6 fw-bold">{{ "{:,}".format(balance|int).replace(',', ' ') }} ₽</div></div>
        <div class="card p-3 border-danger shadow-sm mb-3"><h6 class="text-danger fw-bold small mb-2">ДОБАВИТЬ РАСХОД</h6><form method="POST" class="row g-2"><input type="hidden" name="type" value="expense"><div class="col-7"><input type="number" name="amount" class="form-control form-control-sm" placeholder="Сумма" required step="1" min="1" max="1000000000000000"></div><div class="col-5"><input type="text" name="category" class="form-control form-control-sm" placeholder="Категория" required></div><button class="btn btn-danger btn-sm w-100 mt-2">Записать</button></form></div>
        <div class="card p-3 border-success shadow-sm"><h6 class="text-success fw-bold small mb-2">ДОБАВИТЬ ДОХОД</h6><form method="POST" class="row g-2"><input type="hidden" name="type" value="income"><div class="col-7"><input type="number" name="amount" class="form-control form-control-sm" placeholder="Сумма" required step="1" min="1" max="1000000000000000"></div><div class="col-5"><input type="text" name="category" class="form-control form-control-sm" placeholder="Категория" required></div><button class="btn btn-success btn-sm w-100 mt-2">Записать</button></form></div>
    </div>
    <div class="col-md-3">
        <div class="card shadow-sm border-purple border-3 mb-4 overflow-hidden"><div class="card-header bg-transparent fw-bold small d-flex justify-content-between align-items-center"><span>История операций</span><span class="badge border border-secondary text-muted fw-normal">{{ records|length }}</span></div>
            <form method="GET" class="p-2 border-bottom bg-transparent"><div class="row g-1"><div class="col-6"><select name="filter_type" class="form-select form-select-sm" onchange="this.form.submit()"><option value="all" {% if filter_type == 'all' %}selected{% endif %}>Все типы</option><option value="income" {% if filter_type == 'income' %}selected{% endif %}>Доход</option><option value="expense" {% if filter_type == 'expense' %}selected{% endif %}>Расход</option></select></div><div class="col-6"><select name="filter_cat" class="form-select form-select-sm" onchange="this.form.submit()"><option value="all" {% if filter_cat == 'all' %}selected{% endif %}>Все категории</option>{% for cat in categories %}<option value="{{ cat['category'] }}" {% if filter_cat == cat['category'] %}selected{% endif %}>{{ cat['category'] }}</option>{% endfor %}</select></div></div></form>
            <div style="max-height: 350px; overflow-y: auto;">{% for r in records %}<div class="px-3 py-2 border-bottom d-flex justify-content-between align-items-center"><div style="line-height: 1.2; min-width: 0; flex: 1;" class="me-2"><div class="fw-bold small text-truncate" title="{{ r.category }}"><span class="text-muted me-1">{{ loop.index }}.</span>{{ r.category }}</div><div class="text-muted" style="font-size: 0.75rem;">{{ r.date }}</div></div><div class="text-end d-flex align-items-center flex-shrink-0"><span class="fw-bold small me-2 text-truncate {{ 'text-success' if r.type=='income' else 'text-danger' }}" title="{{ '+' if r.type=='income' else '-' }}{{ "{:,}".format(r.amount|int).replace(',', ' ') }} ₽"> {{ '+' if r.type=='income' else '-' }}{{ "{:,}".format(r.amount|int).replace(',', ' ') }} ₽</span><a href="{{ url_for('delete', id=r.id) }}" class="text-secondary text-decoration-none fw-bold" style="font-size: 1.1rem; line-height: 1;">&times;</a></div></div>{% endfor %}</div>
        </div>
        <div class="card p-3 shadow-sm border-purple border-3"><h6 class="fw-bold small mb-2">Накопление</h6>{% if goal %}<div class="d-flex justify-content-between align-items-start mb-1"><div class="small text-truncate me-2" style="max-width: 150px;" title="{{ goal.description }}"><b>{{ goal.description }}</b></div><a href="{{ url_for('delete_goal') }}" class="text-muted text-decoration-none small">&times; сброс</a></div>
            {% set prog = (balance / goal.target * 100)|int if goal.target > 0 else 0 %}{% set remaining = goal.target - balance %}
            <div class="progress mb-1" style="height: 12px; border-radius: 6px;"><div class="progress-bar {{ 'bg-success' if prog >= 100 else 'bg-purple' }}" style="width: {{ prog if prog <= 100 else 100 }}%">{% if prog >= 10 and prog <= 100 %}{{ prog }}%{% endif %}</div></div>
            {% if remaining > 0 %}<div class="text-center small text-muted mb-2">Осталось: <b>{{ "{:,}".format(remaining|int).replace(',', ' ') }} ₽</b></div>{% elif balance == goal.target %}<div class="text-center small text-success fw-bold mb-2">Цель достигнута!</div>{% else %}<div class="text-center small text-success fw-bold mb-2">Цель перевыполнена! ({{ prog }}%)</div>{% endif %}<button class="btn btn-outline-secondary btn-sm w-100" onclick="document.getElementById('goalForm').classList.toggle('d-none')">Изменить цель</button>
            <div id="goalForm" class="d-none mt-3 border-top pt-2"><form method="POST"><input type="number" name="target" class="form-control form-control-sm mb-2" placeholder="Сумма" required min="1"><input type="text" name="goal_text" class="form-control form-control-sm mb-2" placeholder="Цель" required><button class="btn btn-purple btn-sm w-100">Сохранить</button></form></div>
            {% else %}<form method="POST"><p class="text-muted small mb-2">Установите цель.</p><input type="number" name="target" class="form-control form-control-sm mb-2" placeholder="Сколько?" required min="1"><input type="text" name="goal_text" class="form-control form-control-sm mb-2" placeholder="На что?" required><button class="btn btn-purple btn-sm w-100">Создать</button></form>{% endif %}
        </div>
    </div>
</div></div>
<script>
    Chart.register(ChartDataLabels);
    const charts = {};
    const isDark = document.documentElement.getAttribute('data-bs-theme') === 'dark';

    const configChart = (id, labels, data, colors) => {
        const ctx = document.getElementById(id);
        if (!ctx || data.length === 0) return;

        charts[id] = new Chart(ctx, {
            type: 'pie',
            data: { labels: labels, datasets: [{ data: data, backgroundColor: colors, borderWidth: 0, spacing: 0, hoverOffset: 15 }] },
            options: {
                layout: { padding: 25 },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        enabled: true,
                        backgroundColor: isDark ? 'rgba(255, 255, 255, 0.95)' : 'rgba(0, 0, 0, 0.9)',
                        titleColor: isDark ? '#000' : '#fff',
                        bodyColor: isDark ? '#000' : '#fff',
                        padding: 12,
                        displayColors: false,
                        callbacks: {
                            label: c => {
                                let total = c.dataset.data.reduce((a, b) => a + b, 0);
                                let p = (c.raw / total) * 100;
                                let pStr = "";
                                if (total === c.raw) pStr = "100%";
                                else if (p > 99 && p < 100) pStr = ">99%";
                                else if (p > 0 && p < 1) pStr = "<1%";
                                else pStr = Math.round(p) + "%";

                                let text = ` ${c.label}: ${c.raw.toLocaleString().replace(/,/g, ' ')} ₽ (${pStr})`;
                                const maxLine = 25;
                                if (text.length <= maxLine) return text;
                                const result = [];
                                for (let i = 0; i < text.length; i += maxLine) result.push(text.substring(i, i + maxLine));
                                return result;
                            }
                        }
                    },
                    datalabels: {
                        color: '#ffffff',
                        font: { weight: 'bold', size: 11 },
                        formatter: (v, x) => {
                            let total = x.dataset.data.reduce((a,b)=>a+b,0);
                            let p = (v/total)*100;
                            if (total === v) return "100%";
                            if (p > 99 && p < 100) return ">99%";
                            if (p > 0 && p < 1) return "<1%";
                            let rp = Math.round(p);
                            return rp >= 8 ? rp + "%" : "";
                        }
                    }
                }
            }
        });
    };

    function toggleChart(chartId, index, show) {
        const chart = charts[chartId]; if (!chart) return;
        if (show) {
            chart.setActiveElements([{datasetIndex: 0, index: index}]);
            chart.tooltip.setActiveElements([{datasetIndex: 0, index: index}], {x: 0, y: 0});
        } else {
            chart.setActiveElements([]);
            chart.tooltip.setActiveElements([], {x: 0, y: 0});
        }
        chart.update();
    }

    configChart('expChart', {{ exp_stats.keys()|list|tojson }}, {{ exp_stats.values()|list|tojson }}, ['#b91d1d', '#991b1b', '#7f1d1d', '#c2410c', '#9a3412', '#7c2d12', '#7e22ce', '#6b21a8']);
    configChart('incChart', {{ inc_stats.keys()|list|tojson }}, {{ inc_stats.values()|list|tojson }}, ['#166534', '#14532d', '#065f46', '#064e3b', '#0f766e', '#115e59']);
</script>
{% endblock %}
